name: myapp

services:
  caddy:
    build: ./caddy
    ports:
      - 80:80
      - 443:443
    environment:
      CADDY_SITE_ADDRESS: backend.myapp.com

  postgrest:
    image: postgrest/postgrest:v14.2
    environment:
      PGRST_SERVER_PORT: 3000 # ðŸ‘ˆ unique internal port
      PGRST_DB_URI: postgres://myapp_authenticator:${PGRST_AUTHENTICATOR_PASS:?}@infra.local:5432/myapp
      PGRST_DB_ANON_ROLE: myapp_anon
      PGRST_DB_SCHEMAS: api
      PGRST_JWT_SECRET: ${APP_JWT_SECRET:?}
      PGRST_JWT_SECRET_IS_BASE64: true
    depends_on:
      migrate:
        condition: service_completed_successfully

  migrate:
    build: ./migrate
    environment:
      DATABASE_URL: postgres://myapp_migrator:${MIGRATOR_PASS:?}@infra.local:5432/myapp
    restart: "no"
